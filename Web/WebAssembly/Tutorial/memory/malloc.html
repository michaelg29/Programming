<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>WebAssembly example</title>

    <script>
        var blockSize = 256;
        var maxBlocks = 256;
        var memory = new WebAssembly.Memory({
            initial: blockSize,
            maximum: maxBlocks
        });

        var loaded = false;
        var exports;
        WebAssembly.instantiateStreaming(fetch("malloc.wasm"), {
                js : {
                    mem: memory
                },
                env : {
                    emscripten_resize_heap: function(delta) {memory.grow(delta)}
                }
            }).then(results => {
                loaded = true;
                exports = results.instance.exports;
                memory = results.instance.exports.memory;
            });

        function run_ws() {
            var ptr = exports.wasmmalloc(10 * 4);
            var i32 = new Uint32Array(memory.buffer, ptr);
            for (var i = 0; i < 10; i++) {
                i32[i] = i * 2;
            }

            var sum = exports.accumulate(ptr, 10);
            exports.wasmfree(ptr);
            console.log(sum);

            document.querySelector("#ret")
                .innerHTML += `${sum}<br/>`;
        }

        function copy() {
            var ptr = exports.getString();
            var mem = new Uint8Array(memory.buffer, ptr);
            var strlen = 0;
            while (mem[strlen] != 0) strlen++;

            var str = new TextDecoder('utf8').decode(mem.slice(0, strlen));
            console.log(str);
            navigator.clipboard.writeText(str);

            exports.wasmfree(ptr);
        }
    </script>
  </head>
  
  <body>
    <h1>WebAssembly in C</h1>
    <div style="display: inline-block;">
        <input id="a" type="number" />
        <label>+</label>
        <input id="b" type="number" />
        <button id="run_button" onclick="run_ws()">=</button>
        <label id="ret"></label>
        <button id="copy" onclick="copy()">Copy</button>
    </div>
  </body>
</html>